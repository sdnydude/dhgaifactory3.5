version: '3.8'

services:
  # PostgreSQL 15 with pgvector - DHG Registry Database
  registry-db:
    image: pgvector/pgvector:pg15
    container_name: dhg-registry-db
    environment:
      POSTGRES_USER: dhg_user
      POSTGRES_PASSWORD_FILE: /run/secrets/db_password
      POSTGRES_DB: dhg_registry
    secrets:
      - db_password
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./registry/init-scripts:/docker-entrypoint-initdb.d
    networks:
      - dhg-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dhg_user -d dhg_registry"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Registry API Service
  registry-api:
    build:
      context: ./registry
      dockerfile: Dockerfile
    container_name: dhg-registry-api
    depends_on:
      registry-db:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://dhg_user@registry-db:5432/dhg_registry
      DB_PASSWORD_FILE: /run/secrets/db_password
    secrets:
      - db_password
    ports:
      - "8000:8000"
    networks:
      - dhg-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/healthz"]
      interval: 15s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    labels:
      - "prometheus.scrape=true"
      - "prometheus.port=8000"
      - "prometheus.path=/metrics"

  # ASR Service with GPU support
  asr-service:
    build:
      context: ./asr
      dockerfile: Dockerfile
    container_name: dhg-asr-service
    depends_on:
      registry-api:
        condition: service_healthy
    environment:
      REGISTRY_API_URL: http://registry-api:8000
      CUDA_VISIBLE_DEVICES: "0"
      WHISPER_MODEL: base
    ports:
      - "8001:8000"
    networks:
      - dhg-network
    volumes:
      - asr-models:/root/.cache/whisper
      - ./test-media:/media:ro
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/healthz"]
      interval: 15s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    labels:
      - "prometheus.scrape=true"
      - "prometheus.port=8000"
      - "prometheus.path=/metrics"

  # Prometheus for metrics
  prometheus:
    image: prom/prometheus:latest
    container_name: dhg-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
    volumes:
      - ./observability/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - ./observability/prometheus/alerts.yml:/etc/prometheus/alerts.yml
      - prometheus-data:/prometheus
    ports:
      - "9090:9090"
    networks:
      - dhg-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 15s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  # Grafana for visualization
  grafana:
    image: grafana/grafana:latest
    container_name: dhg-grafana
    depends_on:
      - prometheus
    environment:
      GF_SECURITY_ADMIN_PASSWORD_FILE: /run/secrets/grafana_password
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_SERVER_ROOT_URL: http://localhost:3000
      GF_INSTALL_PLUGINS: ""
    secrets:
      - grafana_password
    volumes:
      - ./observability/grafana/provisioning:/etc/grafana/provisioning
      - ./observability/grafana/dashboards:/var/lib/grafana/dashboards
      - grafana-data:/var/lib/grafana
    ports:
      - "3000:3000"
    networks:
      - dhg-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 15s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  # Loki for log aggregation
  loki:
    image: grafana/loki:latest
    container_name: dhg-loki
    command: -config.file=/etc/loki/loki-config.yml
    volumes:
      - ./observability/loki/loki-config.yml:/etc/loki/loki-config.yml
      - loki-data:/loki
    ports:
      - "3100:3100"
    networks:
      - dhg-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3100/ready"]
      interval: 15s
      timeout: 5s
      retries: 3
    restart: unless-stopped

networks:
  dhg-network:
    driver: bridge
    name: dhg-network

volumes:
  pgdata:
    name: dhg-pgdata
  prometheus-data:
    name: dhg-prometheus-data
  grafana-data:
    name: dhg-grafana-data
  loki-data:
    name: dhg-loki-data
  asr-models:
    name: dhg-asr-models

secrets:
  db_password:
    file: ./secrets/db_password.txt
  grafana_password:
    file: ./secrets/grafana_password.txt
