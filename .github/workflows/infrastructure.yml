name: Infrastructure CI/CD

on:
  push:
    paths:
      - 'infrastructure/**'
    branches: [main, architecture/oss-integrated-stack]
  pull_request:
    paths:
      - 'infrastructure/**'

jobs:
  validate:
    name: Validate Infrastructure
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Docker Compose
        run: |
          cd infrastructure
          docker compose config --quiet
          echo "✓ Docker Compose configuration is valid"

      - name: Lint shell scripts
        uses: azohra/shell-linter@latest
        with:
          path: "infrastructure/*.sh"

      - name: Check for hardcoded secrets
        run: |
          if grep -rE "(password|secret|key).*=.*['\"][^'\"]+['\"]" infrastructure/ --include="*.sh" --include="*.yml" | grep -v "changeme\|template\|example"; then
            echo "⚠️ Potential hardcoded secrets found!"
            exit 1
          fi
          echo "✓ No hardcoded secrets detected"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'infrastructure/'
          format: 'table'
          exit-code: '0'
          severity: 'HIGH,CRITICAL'

  test-setup:
    name: Test Setup Script
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Copy environment template
        run: |
          cd infrastructure
          cp .env.template .env

      - name: Test Docker Compose startup
        run: |
          cd infrastructure
          # Just validate compose file can pull images
          docker compose config
          echo "✓ Configuration validated"
          
      - name: Test scripts are executable
        run: |
          cd infrastructure
          for script in *.sh; do
            if [ -x "$script" ]; then
              echo "✓ $script is executable"
            else
              echo "✗ $script is not executable"
              exit 1
            fi
          done

  docker-scan:
    name: Scan Docker Images
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract image names
        id: images
        run: |
          cd infrastructure
          grep -E "image:" docker-compose.yml | awk '{print $2}' | tr '\n' ',' | sed 's/,$//' > /tmp/images.txt
          echo "images=$(cat /tmp/images.txt)" >> $GITHUB_OUTPUT

      - name: Scan PostgreSQL image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'postgres:15-alpine'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL'
        continue-on-error: true

      - name: Scan Redis image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'redis:7-alpine'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL'
        continue-on-error: true
