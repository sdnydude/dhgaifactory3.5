<!DOCTYPE html>
<html>

<head>
    <title>WebSocket Test v2</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }

        #status {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .log {
            background: #f0f0f0;
            padding: 10px;
            border: 1px solid #ccc;
            height: 300px;
            overflow-y: scroll;
        }
    </style>
</head>

<body>
    <h2>WebSocket Connectivity Test v2</h2>
    <div>Target: <b>ws://10.0.0.251:8011/ws</b></div>
    <div id="status">Status: Disconnected</div>
    <button onclick="connect()">Retry Connection</button>
    <div id="log" class="log"></div>

    <script>
        const url = 'ws://10.0.0.251:8011/ws';
        const logDiv = document.getElementById('log');
        const statusDiv = document.getElementById('status');
        let ws;

        function log(msg) {
            const div = document.createElement('div');
            div.textContent = new Date().toLocaleTimeString() + ': ' + msg;
            logDiv.appendChild(div);
        }

        function connect() {
            if (ws) {
                try { ws.close(); } catch (e) { }
            }

            log('Connecting to ' + url + '...');
            statusDiv.textContent = 'Status: Connecting...';
            statusDiv.style.color = 'blue';

            try {
                ws = new WebSocket(url);

                ws.onopen = function () {
                    log('‚úÖ OPEN - Connection successfully established!');
                    statusDiv.textContent = 'Status: Connected';
                    statusDiv.style.color = 'green';

                    // Send init message as expected by backend
                    const initMsg = {
                        type: "connection.init",
                        payload: { client_version: "1.0.0" }
                    };
                    log('Sending init: ' + JSON.stringify(initMsg));
                    ws.send(JSON.stringify(initMsg));
                };

                ws.onmessage = function (evt) {
                    log('üì© MESSAGE RECEIVED: ' + evt.data);
                };

                ws.onclose = function (evt) {
                    log('‚ùå CLOSED - Code: ' + evt.code + ', Reason: ' + evt.reason);
                    console.log('Close event:', evt);
                    statusDiv.textContent = 'Status: Disconnected';
                    statusDiv.style.color = 'red';
                };

                ws.onerror = function (evt) {
                    log('‚ö†Ô∏è ERROR - Check console for details.');
                    console.error('WebSocket Error:', evt);
                };
            } catch (e) {
                log('üí• EXCEPTION: ' + e.message);
            }
        }

        connect();
    </script>
</body>

</html>